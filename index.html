<!DOCTYPE html>
<html lang="vi">
    <head>
        <meta http-equiv="content-type" content="text/html" charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>TomOi.vn - Backup nhanh Spotify</title>
        <meta name="description" content="Công cụ miễn phí giúp sao lưu và chuyển playlist Spotify giữa các tài khoản nhanh chóng và dễ dàng." />
        <meta name="keywords" content="spotify, backup, chuyển playlist spotify, sao lưu spotify, chuyển nhạc spotify, công cụ spotify, tomoi" />
        <meta name="author" content="TomOi.vn" />
        
        <!-- Open Graph / Facebook -->
        <meta property="og:type" content="website" />
        <meta property="og:url" content="https://tools.tomoi.vn/backup-spotify/" />
        <meta property="og:title" content="TomOi.vn - Công cụ backup nhanh Spotify" />
        <meta property="og:description" content="Sao lưu và chuyển playlist Spotify giữa các tài khoản nhanh chóng và dễ dàng." />
        <meta property="og:image" content="https://tools.tomoi.vn/backup-spotify/og-image.jpg" />

        <!-- Twitter -->
        <meta property="twitter:card" content="summary_large_image" />
        <meta property="twitter:url" content="https://tools.tomoi.vn/backup-spotify/" />
        <meta property="twitter:title" content="TomOi.vn - Backup nhanh Spotify" />
        <meta property="twitter:description" content="Sao lưu và chuyển playlist Spotify giữa các tài khoản nhanh chóng và dễ dàng." />
        <meta property="twitter:image" content="https://tools.tomoi.vn/backup-spotify/og-image.jpg" />
        
        <!-- Favicon -->
        <link rel="icon" href="favicon.ico" type="image/x-icon">
        <link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
        
        <!-- Canonical URL -->
        <link rel="canonical" href="https://tools.tomoi.vn/backup-spotify/" />

        <script type="text/javascript" src="config.js"></script>
        <script type="text/javascript" src="https://code.jquery.com/jquery-1.11.2.min.js"></script>
        <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.2/underscore-min.js"></script>
        <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

        <style type='text/css'>
            :root {
                --spotify-green: #1DB954;
                --spotify-green-hover: #1ED760;
                --dark-bg: #121212;
                --light-bg: #ffffff;
                --text-color: #121212;
                --border-radius: 12px;
                --box-shadow: 0 8px 24px rgba(0,0,0,0.12);
                --transition: all 0.3s ease;
            }

            * {
                box-sizing: border-box;
                margin: 0;
                padding: 0;
            }

            body {
                padding: 0;
                margin: 0;
                font-family: 'Inter', sans-serif;
                background-color: #f5f5f7;
                color: var(--text-color);
                line-height: 1.5;
            }

            .container {
                width: 100%;
                max-width: 960px;
                margin: 24px auto;
                padding: 0 24px;
            }

            .footer {
                position: fixed;
                bottom: 0;
                width: 100%;
                z-index: 100;
            }

            .card {
                background-color: var(--light-bg);
                border-radius: var(--border-radius);
                box-shadow: var(--box-shadow);
                padding: 32px;
                margin-bottom: 24px;
                transition: var(--transition);
            }

            .heading {
                border-radius: var(--border-radius);
                width: 100%;
                z-index: 500;
                padding: 32px;
                display: flex;
                flex-direction: column;
                gap: 16px;
            }

            .logo-container {
                display: flex;
                align-items: center;
                margin-bottom: 24px;
            }

            .logo-icon {
                color: var(--spotify-green);
                font-size: 32px;
                margin-right: 16px;
            }

            .button-main {
                font-size: 16px;
                font-weight: 600;
                color: #fff;
                background-color: var(--spotify-green);
                display: inline-flex;
                align-items: center;
                justify-content: center;
                text-align: center;
                cursor: pointer;
                border: none;
                border-radius: 30px;
                padding: 16px 32px;
                letter-spacing: 0.5px;
                min-width: 180px;
                text-transform: none;
                white-space: normal;
                margin: 16px 0;
                transition: var(--transition);
                box-shadow: 0 4px 12px rgba(29, 185, 84, 0.3);
            }

            .button-main:hover {
                background-color: var(--spotify-green-hover);
                transform: translateY(-2px);
                box-shadow: 0 6px 16px rgba(29, 185, 84, 0.4);
            }

            .button-main i {
                margin-right: 8px;
            }

            .button-row {
                display: flex;
                gap: 24px;
                flex-wrap: wrap;
            }

            .title-bold {
                font-weight: 700; 
                font-size: 48px;
                background: linear-gradient(90deg, #1DB954, #1ED760);
                -webkit-background-clip: text;
                -webkit-text-fill-color: transparent;
                margin: 0;
            }

            .title-light {
                font-weight: 300; 
                color: #333;
                font-size: 48px;
                margin: 0;
            }

            .title-medium {
                font-weight: 600;
                font-size: 20px;
                margin-bottom: 16px;
            }

            .progress-container {
                width: 100%;
                background-color: #eee;
                border-radius: 30px;
                margin: 8px 0 16px 0;
                height: 8px;
                overflow: hidden;
            }

            .progress-bar {
                width: 0%;
                background-color: var(--spotify-green);
                height: 100%;
                border-radius: 30px;
                transition: width 0.4s ease;
            }

            .stats-container {
                display: flex;
                gap: 24px;
                flex-wrap: wrap;
                margin-top: 16px;
            }

            .stat-box {
                background-color: #f9f9f9;
                border-radius: var(--border-radius);
                padding: 16px;
                flex: 1;
                min-width: 140px;
                text-align: center;
            }

            .stat-number {
                font-size: 32px;
                font-weight: 700;
                color: var(--spotify-green);
            }

            .stat-label {
                font-size: 14px;
                color: #666;
            }

            .link {
                font-size: 14px;
                padding: 12px 16px;
                color: #666;
                text-decoration: none;
                transition: var(--transition);
            }
            
            .link:hover {
                color: var(--spotify-green);
            }

            .file-input-container {
                display: flex;
                flex-direction: column;
                gap: 12px;
                width: 100%;
            }

            .custom-file-upload {
                border: 2px dashed #ddd;
                border-radius: var(--border-radius);
                padding: 24px;
                text-align: center;
                cursor: pointer;
                transition: var(--transition);
            }

            .custom-file-upload:hover {
                border-color: var(--spotify-green);
            }

            .custom-file-upload i {
                font-size: 32px;
                color: var(--spotify-green);
                margin-bottom: 12px;
            }

            #fileImport {
                display: none;
            }

            .progress-step {
                display: flex;
                justify-content: space-between;
                margin-bottom: 8px;
            }

            .mobile-hide {
                display: block;
            }

            /* Responsive Design */
            @media (max-width: 768px) {
                .container {
                    padding: 0 16px;
                }
                
                .button-row {
                    flex-direction: column;
                }
                
                .title-bold, .title-light {
                    font-size: 36px;
                }
                
                .mobile-hide {
                    display: none;
                }
                
            }
        </style>
    </head>
    <body>
    

        <div class="container">
            <div class="card heading">
                <div class="logo-container">
                    <i class="fab fa-spotify logo-icon"></i>
                    <div>
                        <span class="title-bold">Tool</span><span class="title-light">Nhanh</span><span class="title-bold">Spotify</span>
                    </div>
                </div>
                
                <div id="pnlLoggedOut">
                    <p style="font-size: 18px; margin-bottom: 24px;"><b>Xuất</b> danh sách playlist và bài hát vào một file với một cú nhấp chuột. <b>Nhập</b> file để chuyển danh sách playlist từ tài khoản này sang tài khoản khác.</p>
                    <button id="login" class="button-main"><i class="fab fa-spotify"></i> Đăng nhập với Spotify</button>
                </div>
            </div>

            <div id="pnlGuide" class="card">
                <h3 class="title-medium">Hướng dẫn sử dụng</h3>
                <div style="margin-top: 16px;">
                    <div style="margin-bottom: 16px;">
                        <h4 style="font-weight: 600; margin-bottom: 8px;"><i class="fas fa-1" style="color: var(--spotify-green); margin-right: 8px; width: 24px; height: 24px; text-align: center; border-radius: 50%; border: 2px solid var(--spotify-green); line-height: 24px; font-size: 14px;"></i> Đăng nhập</h4>
                        <p>Nhấn nút "Đăng nhập với Spotify" và xác thực quyền truy cập vào tài khoản Spotify của bạn.</p>
                    </div>
                    
                    <div style="margin-bottom: 16px;">
                        <h4 style="font-weight: 600; margin-bottom: 8px;"><i class="fas fa-2" style="color: var(--spotify-green); margin-right: 8px; width: 24px; height: 24px; text-align: center; border-radius: 50%; border: 2px solid var(--spotify-green); line-height: 24px; font-size: 14px;"></i> Xuất dữ liệu</h4>
                        <p>Sau khi đăng nhập, hệ thống sẽ tự động tải tất cả playlist và bài hát. Nhấn nút "Xuất" để tải file JSON chứa tất cả dữ liệu của bạn.</p>
                    </div>
                    
                    <div style="margin-bottom: 16px;">
                        <h4 style="font-weight: 600; margin-bottom: 8px;"><i class="fas fa-3" style="color: var(--spotify-green); margin-right: 8px; width: 24px; height: 24px; text-align: center; border-radius: 50%; border: 2px solid var(--spotify-green); line-height: 24px; font-size: 14px;"></i> Đăng xuất và đăng nhập lại</h4>
                        <p>Đăng xuất khỏi tài khoản hiện tại, sau đó đăng nhập bằng tài khoản Spotify khác mà bạn muốn chuyển playlist đến.</p>
                    </div>
                    
                    <div style="margin-bottom: 16px;">
                        <h4 style="font-weight: 600; margin-bottom: 8px;"><i class="fas fa-4" style="color: var(--spotify-green); margin-right: 8px; width: 24px; height: 24px; text-align: center; border-radius: 50%; border: 2px solid var(--spotify-green); line-height: 24px; font-size: 14px;"></i> Nhập dữ liệu</h4>
                        <p>Nhấn nút "Nhập", chọn file JSON đã xuất ở bước 2, và đợi hệ thống sao chép tất cả playlist và bài hát vào tài khoản mới của bạn.</p>
                    </div>
                    
                    <div>
                        <h4 style="font-weight: 600; margin-bottom: 8px;"><i class="fas fa-info-circle" style="color: var(--spotify-green); margin-right: 8px;"></i> Lưu ý</h4>
                        <p>Quá trình nhập có thể mất thời gian tùy thuộc vào số lượng playlist và bài hát trong tài khoản của bạn. Vui lòng không đóng trình duyệt trong quá trình này.</p>
                    </div>
                </div>
            </div>

            <div id="pnlLoadingAccount" class="card heading" style="display: none;">
                <div class="title-medium">Tài khoản: <span id="userName"></span></div>
                
                <div class="stats-container">
                    <div class="stat-box">
                        <div class="stat-number" id="playlistCountDisplay">0</div>
                        <div class="stat-label">Playlist</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-number" id="trackCountDisplay">0</div>
                        <div class="stat-label">Bài hát</div>
                    </div>
                </div>

                <div id="loadingPlaylists" style="margin-top: 16px;"></div>
                <div id="loadingTracks"></div>
                <div id="loadingTitle" style="margin-top: 16px; color: var(--spotify-green);"></div>
                
                <button id="btnLogout" class="button-main" style="background-color: #e74c3c; margin-top: 16px;"><i class="fas fa-sign-out-alt"></i> Đăng xuất</button>
            </div>

            <div id="pnlAction" class="card" style="display: none;">
                <div class="button-row">
                    <button id="btnExport" class="button-main"><i class="fas fa-download"></i> Xuất</button>
                    <button id="btnImport" class="button-main"><i class="fas fa-upload"></i> Nhập</button>
                </div>
            </div>

            <div id="pnlImport" class="card" style="display: none;">
                <div id="pnlFile">
                    <h3 class="title-medium">Nhập dữ liệu Spotify của bạn</h3>
                    <label for="fileImport" class="custom-file-upload">
                        <i class="fas fa-file-import"></i>
                        <div>Chọn file đã xuất trước đó</div>
                    </label>
                    <input type="file" id="fileImport" />
                </div>
                
                <div id="pnlFileInfo" style="display: none;">
                    <div class="title-medium">File: <span id="fileName"></span></div>
                    
                    <div class="stats-container">
                        <div class="stat-box">
                            <div id="filePlaylists"></div>
                            <div class="stat-label">Playlist</div>
                        </div>
                        <div class="stat-box">
                            <div id="fileTracks"></div>
                            <div class="stat-label">Bài hát</div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="pnlUpload" class="card" style="display: none;">
                <div class="title-medium">Đang nhập playlist và bài hát mới</div>
                
                <div class="progress-step">
                    <span>Playlist đã xử lý:</span>
                    <span><span id="playlistStep">0</span>/<span id="playlistTotal">0</span></span>
                </div>
                
                <div class="progress-step">
                    <span>Bài hát đã xử lý:</span>
                    <span><span id="trackStep">0</span>/<span id="trackTotal">0</span></span>
                </div>
                
                <div id="globalStep" style="margin: 16px 0; font-weight: 500; color: var(--spotify-green);"></div>
                
                <div class="progress-container">
                    <div id="progressBar" class="progress-bar"></div>
                </div>
            </div>
        </div>

        <div class="footer">

        </div>

        <script type='text/javascript'>

var conf = config;

var authWindow = null;
var token = null;
var userId = '';
var collections = {};
var name = 'spotify';

var isImporting = false;
var isExporting = false;
var globalStep = "";
var playlistStep = 0;
var trackStep = 0;
var trackTotal = 0;

var playlistQueue = [];
var savedQueue = [];

var makingChanges = false;

function refreshTrackData(callback) {
    if (!isExporting && !isImporting) {
        isExporting = true;
        resetCounter();
        $('#pnlLoadingAccount').show();
        $('#loadingTitle').html('Please wait. Loading your playlists and tracks ...');
        refreshPlaylist(function () {
            refreshMyMusicTracks(function () {
                // refreshStarredTracks(function () {
                    $('#loadingTitle').html('Finished loading, you now might want to export or import.');
                    isExporting = false;
                    callback();
                // });
            });
        }); 
    }
}

function resetCounter() {
    globalStep = '';
    playlistStep = 0;
    playlistTotal = 0;
    trackStep = 0;
    trackTotal = 0;
}

function refreshProgress() {
    $('#globalStep').html(globalStep);
    $('#playlistStep').html(playlistStep);
    $('#playlistTotal').html(playlistTotal);
    $('#trackStep').html(trackStep);
    $('#trackTotal').html(trackTotal);
    var progress = 0;
    if (trackTotal > 0) {
        var progress = Math.floor(((trackStep / trackTotal) * 100));
    }
    $('#progressBar').css('width', progress+'%')
    if (typeof collections !== 'undefined' && !makingChanges) {
        var set = collectionProperties(collections);
        $('#loadingPlaylists').html(""+set.playlistCount+" playlists");
        $('#loadingTracks').html(""+set.trackCount+" tracks");
        $('#playlistCountDisplay').html(set.playlistCount);
        $('#trackCountDisplay').html(set.trackCount);
    }
    if (typeof importColl !== 'undefined') {
        var set2 = collectionProperties(importColl);
        $('#filePlaylists').html(""+set2.playlistCount);
        $('#fileTracks').html(""+set2.trackCount);
    }
    setTimeout(refreshProgress, 1000);
}

function login() {
    var width = 480, height = 640;
    var left = (screen.width / 2) - (width / 2);
    var top = (screen.height / 2) - (height / 2);

    var set = {
      client_id: conf.client_id,
      redirect_uri: conf.redirect_uri,
      scope: 'user-read-private user-read-email playlist-read-private playlist-read-collaborative playlist-modify-public playlist-modify-private user-library-read user-library-modify',
      response_type: 'token',
      show_dialog: 'true'
    };
    authWindow = window.open(
        "https://accounts.spotify.com/authorize?" + urlEncodeSet(set),
        "Spotify",
        'menubar=no,location=no,resizable=no,scrollbars=no,status=no, width=' + width + ', height=' + height + ', top=' + top + ', left=' + left
    );
}

function authCallback(event){
    if (event.origin !== conf.uri) {
        console.log("config.uri missconfigured:");
        console.log({ uri: conf.uri, origin: event.origin });
        alert("Lỗi cấu hình URI: URI trong config (" + conf.uri + ") không khớp với origin (" + event.origin + ")");
        return;
    }
    if (authWindow) {
        authWindow.close();
    }
    
    // Kiểm tra nếu token là null hoặc undefined
    if (!event.data) {
        console.error("Token không hợp lệ hoặc không nhận được");
        alert("Không thể lấy token xác thực từ Spotify. Vui lòng thử lại.");
        return;
    }
    
    // Lưu token vào localStorage để dễ debugging
    window.localStorage.setItem('spotify_token', event.data);
    
    handleAuth(event.data);
}

function urlEncodeSet(set) {
    var comps = [];
    for (var i in set) {
        if (set.hasOwnProperty(i)) {
            comps.push(encodeURIComponent(i)+"="+encodeURIComponent(set[i]));
        }
    }
    var string = comps.join("&");
    return string;
}

function download(filename, text) {
    var pom = document.createElement('a');
    pom.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(text));
    pom.setAttribute('download', filename);

    if (document.createEvent) {
        var event = document.createEvent('MouseEvents');
        event.initEvent('click', true, true);
        pom.dispatchEvent(event);
    }
    else {
        pom.click();
    }
}

function readFile(evt) {
    //Retrieve the first (and only!) File from the FileList object
    var f = evt.target.files[0]; 

    if (f) {
        $('#fileName').html(f.name);

        var r = new FileReader();
        r.onload = function(e) { 
            var json = e.target.result;

            importColl = JSON.parse(json);

            $('#pnlFile').hide();
            $('#pnlFileInfo').show();
            $('#pnlUpload').show();

            compareEverything();
        }
        r.readAsText(f);
    } else { 
      alert("Failed to load file");
    }
}

function collectionProperties(coll) {
    return { playlistCount: collPlaylistCount(coll), trackCount: collTrackCount(coll) };
}

function collTrackCount(coll) {
    var count = 0;
    var keys = _.keys(coll.playlists);
    $.each(keys, function (index, value) {
        count += coll.playlists[value].tracks.length;
    });
    if (coll.starred) {
        count += coll.starred.length;
    }
    if (coll.saved) {
        count += coll.saved.length;
    }
    return count;
}

function collPlaylistCount(coll) {
    var keys = _.keys(coll.playlists);
    var count = keys.length + 1;
    if (!("importedStarred" in keys)) {
        count++;
    }
    return count;
}

function compareEverything() {
    if (!isImporting && !isExporting) {
        isImporting = true;
        makingChanges = true;
        resetCounter();

        savedQueue = [];
        playlistQueue = [];

        globalStep = "Uploading";
        if (typeof importColl !== 'undefined') {

            playlistTotal = collPlaylistCount(importColl);            

            // TONOTDO:compare starred -> can not really do that since there is no api to manipulate those
            // instead we just create a replacement-standard-list
            globalStep = "Comparing starred tracks";
            
            makeSureImportedStarredExists(function (proceed) {
                if (importColl.starred && importColl.starred.length > 0) {
                    compareUriTracks(importColl.starred, collections.starred, addToStarred);
                }
                // compare saved
                globalStep = "Comparing saved tracks";
                compareIdTracks(importColl.saved, collections.saved, addToSaved);
                playlistStep += 1;

                // compare other playlists
                var playlistNames = _.keys(importColl.playlists);
                globalStep = "Comparing custom playlists";
                handlePlaylistCompare(playlistNames.reverse(), function () {
                    handleTrackUpload();
                });
            });
        }
    }
}

function handleTrackUpload() {

    trackDiff = savedQueue.length + playlistQueue.length;
    trackTotal = Math.max(collTrackCount(importColl), trackDiff);
    trackStep = trackTotal - trackDiff;


    if (trackTotal > 0) {
        $('#progressBar').show();
        globalStep = "Uploading tracks";
        handleSavedRequests(savedQueue.reverse(), function () {
            handlePlaylistRequests(playlistQueue.reverse(), function () {
                globalStep = "Finished uploading";
                trackTotal = trackStep;
                isImporting = false;
            });
        });
    } else {
        globalStep = "No new tracks found in import";
    }
}

function handlePlaylistCompare(names, callback) {
    var name = names.pop();
    if (!name) {
        callback();
        return;
    }
    makeSurePlaylistExists(name, function (proceed) {
        if (proceed) {
            var playlistId = collections.playlists[name].id;
            compareUriTracks(importColl.playlists[name].tracks, collections.playlists[name].tracks, function (uri) {
                addToPlaylist(playlistId, uri);
            });
        }
        handlePlaylistCompare(names, callback);
    });
}

function addToPlaylist(playlistId, trackUri) {
    playlistQueue.push('https://api.spotify.com/v1/users/' + userId + '/playlists/' + playlistId + '/tracks?uris=' + encodeURIComponent(trackUri));
}

function makeSurePlaylistExists(name, callback) {
    playlistStep += 1;
    if (name in collections.playlists) {
        callback(true);
        return;
    }
    var set = { name: name, public: "true" };
    $.ajax({
        method: "POST",
        url: 'https://api.spotify.com/v1/users/' + userId + '/playlists',
        data: JSON.stringify(set),
        contentType: 'application/json',
        headers: {
        'Authorization': 'Bearer ' + token
        },
        success: function(response) {         
            // alert(JSON.stringify(response));
            collections.playlists[response.name] = {
                name: response.name,
                href: response.tracks.href,
                id: response.id,
                tracks: []
            };
            callback(true);
        },
        fail: function () {
            callback(false);
        }
    });
}

function makeSureImportedStarredExists(callback) {
    var name = 'importedStarred';
    makeSurePlaylistExists(name, callback);
}

function addToStarred(trackUri) {
    var name = 'importedStarred';
    var playlistId = collections.playlists[name].id;
    uriInTracks(trackUri, collections.playlists[name].tracks, function (uri) {
        addToPlaylist(playlistId, uri);
    });
}

function handleSavedRequests(arr, callback) {
    var url = arr.pop();
    if (url) {
        trackStep += 1;
        $.ajax({
            method: "PUT",
            url: url,
            headers: {
            'Authorization': 'Bearer ' + token
            },
            success: function () {
            },
            fail: function (jqXHR, textStatus, errorThrown) {
                console.log(errorThrown);
            }
        })
        .always(function () {
            handleSavedRequests(arr, callback);
        });
    } else {
        callback();
    }
}


function handlePlaylistRequestsWithTimeout(arr, callback) {
        setTimeout(function() { console.log("Fast runners are dead runners"); handlePlaylistRequests(arr, callback) }, conf.slowdown_import);
}

function handlePlaylistRequests(arr, callback) {
    var url = arr.pop();
    if (url) {
        trackStep += 1;   
        $.ajax({
            method: "POST",
            url: url,
            contentType: 'application/json',
            headers: {
            'Authorization': 'Bearer ' + token
            },
            success: function(response) {      
                // collections.playlists[response.name] = {
                //     id: response.id,
                //     uri: response.uri
                // };
            },
            fail: function (jqXHR, textStatus, errorThrown) {
                console.log(errorThrown);
            }
        })
        .always(function () {
            handlePlaylistRequestsWithTimeout(arr, callback);
        })
    } else {
        callback();
    }
}

function uriInTracks(uri, tracks, addCallback) {
    var found = false;
    $.each(tracks, function (index, value) {
        if (value.uri == uri) {
            found = true;
        }
    });
    if (!found) {
        addCallback(uri);
    }
}

function addToSaved(id) {
    savedQueue.push('https://api.spotify.com/v1/me/tracks?ids='+id);
}

function compareUriTracks(imported, stored, addCallback) {
    $.each(imported, function (index, value) {
        var found = false;
        $.each(stored, function (index2, value2) {
            if (value.uri == value2.uri) {
                found = true;
            }
        });
        if (!found) {
            addCallback(value.uri);
        }
    });
}

function compareIdTracks(imported, stored, addCallback) {
    $.each(imported, function (index, value) {
        var found = false;
        $.each(stored, function (index2, value2) {
            if (value.id == value2.id) {
                found = true;
            }
        });
        if (!found) {
            addCallback(value.id);
        }
    });
}

function bindControls() {
    $('#btnImport').click(function () {
        $('#pnlAction').hide();
        $('#pnlImport').show();
    });
    $('#btnExport').click(function () {
        var json = JSON.stringify(collections);
        var d = new Date();
        var time = '@' + d.getFullYear() + '_' + (d.getMonth() + 1) + '_' + d.getDate();
        download(name+time+'.json', json);
    });
    $('#btnLogout').click(function() {
        window.localStorage.removeItem('spotify_token');
        location.reload();
    });
    $('#fileImport').change(readFile);
}

function handleAuth(accessToken) {
    token = accessToken;
    // fetch my public playlists
    $.ajax({
        url: 'https://api.spotify.com/v1/me',
        headers: {
        'Authorization': 'Bearer ' + accessToken
        },
        success: function(response) {         
            var user_id = response.id.toLowerCase();
            userId = user_id;
            name = user_id;

            $('#userName').html(name);
            $('#pnlLoggedOut').hide();

            refreshTrackData(function () {                   
                $('#pnlAction').show();
            });
        }
    });
}

function refreshMyMusicTracks(callback) {
    collections.saved = [];
    playlistStep += 1;
    loadTrackChunks('https://api.spotify.com/v1/me/tracks', collections.saved, callback);
}

// DEPRECATED
// function refreshStarredTracks(callback) {
//     collections.starred = [];
//     playlistStep += 1;
//     loadStarred('https://api.spotify.com/v1/users/' + userId + '/starred', collections.starred, callback)
// }

// DEPRECATED
// function loadStarred(url, arr, callback) {
//     $.ajax({
//         url: url,
//         headers: {
//             'Authorization': 'Bearer ' + token
//         },
//         success: function(data) {         
//             if (!data) return;
//             if ('tracks' in data) {
//                 loadTrackChunks(data.tracks.href, arr, callback);
//             } else {
//                 callback();
//             }                
//         }
//     });
// }

function loadTrackChunksWithTimeout(url, arr, callback, timeout) {
        setTimeout(function() { console.log("Taking breath, not to fast my cheetah"); loadTrackChunks(url, arr, callback) }, conf.slowdown_export);
}

function loadTrackChunks(url, arr, callback) {
    $.ajax({
        url: url,
        headers: {
            'Authorization': 'Bearer ' + token
        },
        success: function (data) {
            if (!data) return;
            if ('items' in data) {
                $.each(data.items, function (index, value) {
                    if(value.track !== null){
                        arr.push({ id: value.track.id, uri: value.track.uri });    
                    }else{
                        console.log("track is null", value);
                    }                    
                });
            } else {
                arr.push({ id: data.track.id, uri: data.track.uri });
            }
            if (data.next) {
                loadTrackChunksWithTimeout(data.next, arr, callback);
            } else {
                callback();
            }
        }
    });
}

function refreshPlaylist(callback) {
    collections.playlists = {};
    var playlists = [];
    loadPlaylistChunks('https://api.spotify.com/v1/users/' + userId + '/playlists', playlists, function () {
        handlePlaylistTracks(playlists, collections.playlists, callback);
    });
}

function loadPlaylistChunks(url, arr, callback) {
    $.ajax({
        url: url,
        headers: {
            'Authorization': 'Bearer ' + token
        },
        success: function (data) {
            if (!data) return;
            if ('items' in data) {
                $.each(data.items, function (index, value) {
                    if (value.tracks && value.tracks.href) {
                        arr.push({
                            name: value.name,
                            href: value.tracks.href,
                            id: value.id,
                            tracks: []
                        });
                    }
                });
            } else {
                if (data.tracks && data.tracks.href) {
                    arr.push({
                        name: data.name,
                        href: data.tracks.href,
                        id: value.id,
                        tracks: []
                    });
                }
            }
            if (data.next) {
                loadPlaylistChunks(data.next, arr, callback);
            } else {
                callback();
            }
        }
    });
}

function handlePlaylistTracks(arr, result, callback) {
    var item = arr.pop();
    if (!item) {
        return callback();
    }
    playlistStep += 1;
    item.tracks = [];
    loadTrackChunks(item.href, item.tracks, function () {
        delete item.href;
        result[item.name] = item;
        if (arr.length == 0) {
            callback();
        } else {
            handlePlaylistTracks(arr, result, callback);
        }
    });
}

window.onload = function() {
    if (navigator.userAgent.indexOf('MSIE') !== -1 || navigator.appVersion.indexOf('Trident/') > 0) {
        // MSIE
        $('#pnlLoggedOut').html('Please use Firefox or Chrome, due to a bug in Internet Explorer');
    } else {
        $('#login').click(login);
        window.addEventListener("message", authCallback, false);
        bindControls();
        refreshProgress();
    }
}

        </script>
    </body>
</html>
